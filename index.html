<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Interactive Land Plots - Cesium</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
html, body, #cesiumContainer {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
}
</style>
</head>
<body>
<div id="cesiumContainer"></div>

<script>
// توكن Cesium Ion الجديد (آخر توكن زودتني به)
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhYzg2MjkyYS03YWU1LTQ1MTUtODAyOS03YWE4N2Q3M2M5Y2YiLCJpZCI6MzU1MzM3LCJpYXQiOjE3NjQxOTk3MzV9.t1H3PYoQg-7-p8RPUU2ruN8cmiRoBI72HpkrTKkQbiQ';

let selectedPlotLabel = undefined;
let viewer = null;

try {
    viewer = new Cesium.Viewer("cesiumContainer", {
        terrain: Cesium.Terrain.fromWorldTerrain(),
        imageryProvider: Cesium.createWorldImagery({
            style: Cesium.ImageryLayerStyle.AERIAL
        }),
        animation: false,
        timeline: false,
        baseLayerPicker: true,
        fullscreenButton: true,
        geocoder: false,
        homeButton: true,
        navigationHelpButton: false,
        infoBox: false
    });
    console.log("Cesium Viewer initialized successfully.");

} catch (error) {
    console.error("خطأ أثناء تهيئة Cesium Viewer:", error);
    alert(`حدث خطأ أثناء تهيئة الخريطة: ${error.message}. يرجى التحقق من دعم المتصفح لـ WebGL.`);
}

async function loadLandPlots(dataSourcePath) {
    if (!viewer) {
        console.error("Cesium Viewer غير مهيأ، لا يمكن تحميل البيانات.");
        alert("خطأ: لم يتم تهيئة الخريطة، لا يمكن تحميل البيانات.");
        return;
    }

    try {
        console.log(`بدء تحميل ملف KML من: ${dataSourcePath}`);
        
        const kmlDataSource = await Cesium.KmlDataSource.load(dataSourcePath, {
            camera: viewer.scene.camera,
            canvas: viewer.scene.canvas,
            clampToGround: true
        });

        await viewer.dataSources.add(kmlDataSource);
        await viewer.zoomTo(kmlDataSource);
        console.log(`تم تحميل ${kmlDataSource.entities.values.length} قطعة أرض من ملف KML بنجاح.`);

        kmlDataSource.entities.values.forEach(entity => {
            if (Cesium.defined(entity.polygon)) {
                const statusProperty = entity.properties && entity.properties.status;
                const status = statusProperty && statusProperty.getValue();

                if (status === 'مباع') {
                     entity.polygon.material = Cesium.Color.RED.withAlpha(0.4);
                     entity.polygon.outlineColor = Cesium.Color.RED.withAlpha(0.7);
                } else {
                    entity.polygon.material = Cesium.Color.fromCssColorString('#4CAF50').withAlpha(0.4);
                    entity.polygon.outlineColor = Cesium.Color.BLACK.withAlpha(0.7);
                }
                entity.polygon.outlineWidth = 3;
            }
        });

    } catch (error) {
        console.error('حدث خطأ أثناء تحميل قطع الأراضي من KML:', error);
        alert('حدث خطأ أثناء تحميل ملف KML: يرجى التحقق من المسار والتنسيق.');
    }
}

// استدعاء دالة تحميل KML، مع تحديد اسم الملف إلى data.kml
loadLandPlots('./data.kml');

const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction(function(click) {
    if (Cesium.defined(selectedPlotLabel)) {
        viewer.entities.remove(selectedPlotLabel);
        selectedPlotLabel = undefined;
    }

    const pickedObject = viewer.scene.pick(click.position);

    if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id) && pickedObject.id.polygon) {
        const clickedPlot = pickedObject.id;
        const properties = clickedPlot.properties;

        if (Cesium.defined(properties)) {
            let labelText = '';
            if (properties.id && properties.id.getValue()) labelText += `معرف القطعة: ${properties.id.getValue()}\n`;
            if (properties.status && properties.status.getValue()) labelText += `الحالة: ${properties.status.getValue()}\n`;
            if (properties.area && properties.area.getValue()) labelText += `المساحة: ${properties.area.getValue()} متر مربع\n`;
            if (properties.price && properties.price.getValue()) labelText += `السعر: ${properties.price.getValue()}\n`;

            const polygonHierarchy = clickedPlot.polygon.hierarchy.getValue();
            const centroid = Cesium.BoundingSphere.fromPoints(polygonHierarchy.positions).center;
            const cartographicCentroid = Cesium.Cartographic.fromCartesian(centroid);
            const longitude = Cesium.Math.toDegrees(cartographicCentroid.longitude);
            const latitude = Cesium.Math.toDegrees(cartographicCentroid.latitude);

            selectedPlotLabel = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(longitude, latitude, 0),
                label: {
                    text: labelText.trim(),
                    font: '20px sans-serif',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -20),
                    heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                    backgroundColor: Cesium.Color.fromCssColorString('#424242').withAlpha(0.7),
                    showBackground: true,
                }
            });

            viewer.selectedEntity = clickedPlot;
        }
    } else {
        viewer.selectedEntity = undefined;
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

viewer.camera.changed.addEventListener(function() {
    if (Cesium.defined(selectedPlotLabel)) {
        viewer.entities.remove(selectedPlotLabel);
        selectedPlotLabel = undefined;
        viewer.selectedEntity = undefined;
    }
});
</script>
</body>
</html>
