<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Ø¹Ø§Ø±Ø¶ KML - Cesium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Cesium Ù…Ù† CDN -->
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      direction: rtl;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    }
    #topbar{
      position: absolute;
      z-index: 99;
      left: 12px;
      top: 12px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #token {
      width: 420px;
      font-size: 13px;
    }
    button { margin-left:8px; padding:6px 10px; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <div id="topbar">
    <div style="margin-bottom:6px;"><strong>Ø¹Ø§Ø±Ø¶ KML Ù…Ø­Ù„ÙŠ - Cesium</strong></div>
    <!-- Ø¶Ø¹ ØªÙˆÙƒÙ† Cesium Ion Ù‡Ù†Ø§ Ø«Ù… Ø§Ø¶ØºØ· ØªØ­Ù…ÙŠÙ„ -->
    <label for="token">Cesium Ion Access Token:</label>
    <input id="token" placeholder="Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§" />
    <button id="loadBtn">ØªØ­Ù…ÙŠÙ„ ÙˆÙØªØ­ KML</button>
    <div id="status" style="margin-top:6px;color:#333;"></div>
  </div>

  <script>
    // Ù†Ø­ØªÙØ¸ Ø¨Ù…ØªØºÙŠØ± viewer Ù„ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ Ù„Ø²Ù…
    let viewer = null;

    function createViewer() {
      if (viewer) {
        try { viewer.destroy(); } catch(e) {}
      }
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙƒÙ† Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯
      const token = Cesium.Ion.defaultAccessToken;
      if (!token) {
        document.getElementById('status').textContent = 'âš  Ø§Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ù€ Cesium Ion ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ ÙˆÙØªØ­ KML".';
      }
      viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: Cesium.Terrain.createWorldTerrain ? Cesium.Terrain.createWorldTerrain() : undefined,
        baseLayerPicker: true,
        geocoder: true,
        homeButton: true,
        sceneModePicker: true,
        timeline: false,
        animation: false
      });
    }

    document.getElementById('loadBtn').addEventListener('click', function() {
      const inputToken = document.getElementById('token').value.trim();
      if (!inputToken) {
        document.getElementById('status').textContent = 'ğŸ›‘ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† ØµØ§Ù„Ø­ Ù…Ù† Cesium Ion.';
        return;
      }
      Cesium.Ion.defaultAccessToken = inputToken;
      document.getElementById('status').textContent = 'ğŸ”„ Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯...';
      try {
        createViewer();
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = 'âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯: ' + e.message;
        return;
      }

      // Ù†Ø­Ù…Ù„ Ù…Ù„Ù KML Ø§Ù„Ù…Ø­Ù„ÙŠ (data.kml)
      const kmlUrl = 'data.kml';
      Cesium.KmlDataSource.load(kmlUrl, { clampToGround: true })
        .then(function(dataSource) {
          viewer.dataSources.add(dataSource);
          // Ø¶Ø¨Ø· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù€ KML
          viewer.zoomTo(dataSource).otherwise(function(err){
            console.warn('zoomTo failed', err);
          });
          document.getElementById('status').textContent = 'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ KML Ø¨Ù†Ø¬Ø§Ø­.';
        })
        .catch(function(err){
          console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ KML:', err);
          // ØªÙØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø·
          let msg = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ KML. ';
          if (err && err.message && err.message.indexOf('401') !== -1) {
            msg += 'Ø§Ù„Ø®Ø·Ø£ 401: ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© ØªÙˆÙƒÙ† Cesium Ion ÙˆØ£Ù† Ù„Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.';
          } else if (err && err.message) {
            msg += err.message;
          }
          msg += ' Ø§ÙØªØ­ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… (Console) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±.';
          document.getElementById('status').textContent = msg;
        });
    });

    // ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ù€ localStorage Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØªÙˆÙƒÙ† Ù…Ø­ÙÙˆØ¸ Ø¥Ù† ÙˆÙØ¬Ø¯
    (function(){
      try {
        const saved = localStorage.getItem('cesium_ion_token');
        if (saved) {
          document.getElementById('token').value = saved;
        }
      } catch(e){}
    })();

    // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡
    document.getElementById('token').addEventListener('change', function(){
      try { localStorage.setItem('cesium_ion_token', this.value); } catch(e){}
    });
  </script>
</body>
</html>
